{% extends 'base.html' %}
{% load static %}

{% block title %}Tableau de Bord - Hôtel La Résilience{% endblock %}

{% block content %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="row mb-4 animate-fade-in">
    <div class="col-md-8">
        <h2 class="section-title">Tableau de Bord</h2>
        <p class="text-muted lead">Indicateurs clés et suivi des performances.</p>
    </div>
    <div class="col-md-4 text-end">
        <div class="d-inline-flex align-items-center bg-white shadow-sm p-2 rounded-pill pe-4">
            <div class="rounded-circle bg-primary bg-opacity-10 text-primary d-flex align-items-center justify-content-center me-3"
                style="width: 45px; height: 45px;">
                <i class="fa-solid fa-cloud-sun fs-5"></i>
            </div>
            <div class="text-start me-3 border-end pe-3">
                <div class="fw-bold text-dark small" id="live-time">--:--</div>
                <div class="text-muted" style="font-size: 0.7rem;">{% now "d M Y" %}</div>
            </div>
            <div class="text-start">
                <div class="fw-bold text-dark small">28°C</div>
                <div class="text-muted" style="font-size: 0.7rem;">Ensoleillé</div>
            </div>
        </div>
    </div>
</div>

<!-- 1. KPI Cards Row -->
<div class="row mb-5 g-4">
    <!-- Taux d'occupation -->
    <div class="col-xl-3 col-md-6 animate-fade-in delay-1">
        <div class="glass-card p-4 h-100 position-relative">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="text-muted fw-bold text-uppercase small">Occupation</div>
                <div class="icon-shape bg-primary bg-opacity-10 text-primary rounded-circle p-2">
                    <i class="fa-solid fa-bed fs-4"></i>
                </div>
            </div>
            <h2 class="fw-bold mb-0">{{ occupation_rate }}%</h2>
            <div class="progress mt-2 mb-2" style="height: 4px;">
                <div class="progress-bar bg-primary" role="progressbar" style="width: {{ occupation_rate }}%"></div>
            </div>
            <small class="text-muted">{{ occupied_rooms }}/{{ total_rooms }} chambres occupées</small>
        </div>
    </div>

    <!-- Revenus Mensuels -->
    <div class="col-xl-3 col-md-6 animate-fade-in delay-2">
        <div class="glass-card p-4 h-100">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="text-muted fw-bold text-uppercase small">Revenus (Mois)</div>
                <div class="icon-shape bg-success bg-opacity-10 text-success rounded-circle p-2">
                    <i class="fa-solid fa-wallet fs-4"></i>
                </div>
            </div>
            <h2 class="fw-bold mb-0">{{ monthly_revenue|floatformat:0 }} <span class="fs-6 text-muted">FCFA</span></h2>
            <small class="text-success"><i class="fa-solid fa-arrow-trend-up"></i> Encaissé ce mois</small>
        </div>
    </div>

    <!-- Réservations Futures -->
    <div class="col-xl-3 col-md-6 animate-fade-in delay-3">
        <div class="glass-card p-4 h-100">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="text-muted fw-bold text-uppercase small">Réservations</div>
                <div class="icon-shape bg-warning bg-opacity-10 text-warning rounded-circle p-2">
                    <i class="fa-regular fa-calendar-check fs-4"></i>
                </div>
            </div>
            <h2 class="fw-bold mb-0">{{ upcoming_reservations }}</h2>
            <small class="text-muted">Arrivées prévues (Check-ins)</small>
        </div>
    </div>

    <!-- Total Clients -->
    <div class="col-xl-3 col-md-6 animate-fade-in delay-4">
        <div class="glass-card p-4 h-100">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="text-muted fw-bold text-uppercase small">Clients</div>
                <div class="icon-shape bg-danger bg-opacity-10 text-danger rounded-circle p-2">
                    <i class="fa-solid fa-users fs-4"></i>
                </div>
            </div>
            <h2 class="fw-bold mb-0">{{ total_clients }}</h2>
            <small class="text-muted">Total base de données</small>
        </div>
    </div>
</div>

<!-- 2. Charts Section -->
<div class="row mb-5 g-4">
    <!-- Revenue Evolution -->
    <div class="col-lg-8 animate-fade-in delay-2">
        <div class="glass-card p-4 h-100">
            <h5 class="mb-4 fw-bold">Évolution des Revenus (6 derniers mois)</h5>
            <div style="height: 300px;">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Room Category Distribution -->
    <div class="col-lg-4 animate-fade-in delay-3">
        <div class="glass-card p-4 h-100">
            <h5 class="mb-4 fw-bold">Popularité des Chambres</h5>
            <div style="height: 250px; position: relative;">
                <canvas id="categoryChart"></canvas>
            </div>
            <div class="mt-4 text-center small text-muted">
                Basé sur le total des réservations
            </div>
        </div>
    </div>
</div>

<!-- 3. Visual Room Rack (Interactive Map) -->
<div class="row mb-5 animate-fade-in delay-3">
    <div class="col-12">
        <div class="glass-card p-4">
            <div class="d-flex align-items-center justify-content-between mb-4">
                <h4 class="mb-0 fw-bold"><i class="fa-solid fa-layer-group me-2 text-primary"></i>Vue du Parc Hôtelier
                </h4>

                <div class="d-flex gap-3 small">
                    <span class="d-flex align-items-center"><span class="badge rounded-circle bg-success p-1 me-2"
                            style="width:10px; height:10px;"></span> Libre</span>
                    <span class="d-flex align-items-center"><span class="badge rounded-circle bg-danger p-1 me-2"
                            style="width:10px; height:10px;"></span> Occupée</span>
                    <span class="d-flex align-items-center"><span class="badge rounded-circle bg-secondary p-1 me-2"
                            style="width:10px; height:10px;"></span> Maintenance</span>
                </div>
            </div>

            <div class="row g-3">
                {% for room in room_list %}
                <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
                    <div
                        class="card h-100 room-card position-relative overflow-hidden border-0 shadow-sm
                        {% if room.status == 'LIBRE' %}status-free{% elif room.status == 'OCCUPEE' %}status-busy{% else %}status-maint{% endif %}">

                        <!-- Status Strip -->
                        <div class="status-strip"></div>

                        <div class="card-body p-3 text-center">
                            <h5 class="fw-bold mb-1">Chbe {{ room.number }}</h5>
                            <span class="badge bg-white text-muted border mb-2 rounded-pill small">{{
                                room.get_category_display }}</span>

                            <div class="mt-2">
                                {% if room.status == 'LIBRE' %}
                                <i class="fa-solid fa-door-open fs-3 text-success opacity-75 mb-2"></i>
                                <div class="d-grid">
                                    <a href="/admin/core/reservation/add/?room={{ room.id }}"
                                        class="btn btn-sm btn-outline-success rounded-pill py-1"
                                        style="font-size: 0.75rem;">
                                        Réserver
                                    </a>
                                </div>
                                {% elif room.status == 'OCCUPEE' %}
                                <i class="fa-solid fa-user-lock fs-3 text-danger opacity-75 mb-2"></i>
                                <div class="small text-danger fw-bold">Occupée</div>
                                {% else %}
                                <i class="fa-solid fa-tools fs-3 text-secondary opacity-75 mb-2"></i>
                                <div class="small text-muted">Maintenance</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Hover Info -->
                        <div class="room-overlay">
                            <small class="text-white fw-bold">{{ room.price_per_night }} FCFA</small>
                            <span class="text-white-50 small">par nuit</span>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-12 text-center text-muted py-5">
                    Aucune chambre configurée.
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- 4. Recent Activity (Reservations Table) -->
<div class="row g-4 mb-5">
    <!-- Recent Reservations Table -->
    <div class="col-lg-12 animate-fade-in delay-3">
        <div class="glass-card p-0 h-100 overflow-hidden">
            <div class="p-4 border-bottom bg-light bg-opacity-25 d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-bold">Dernières Réservations</h5>
                <a href="/admin/core/reservation/" class="btn btn-sm btn-outline-primary rounded-pill px-3">Tout
                    voir</a>
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-4">Client</th>
                            <th>Chambre</th>
                            <th>Dates</th>
                            <th>Statut</th>
                            <th class="text-end pe-4">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for res in recent_reservations %}
                        <tr>
                            <td class="ps-4 fw-medium">{{ res.client.first_name }} {{ res.client.last_name }}</td>
                            <td>
                                <span class="badge bg-secondary bg-opacity-10 text-dark border">{{ res.room.number
                                    }}</span>
                                <small class="text-muted ms-1">{{ res.room.get_category_display }}</small>
                            </td>
                            <td>
                                <small class="d-block">{{ res.check_in|date:"d M" }} - {{ res.check_out|date:"d M"
                                    }}</small>
                            </td>
                            <td>
                                {% if res.status == 'CONFIRMEE' %}
                                <span class="badge bg-success bg-opacity-10 text-success">Confirmée</span>
                                {% elif res.status == 'EN_ATTENTE' %}
                                <span class="badge bg-warning bg-opacity-10 text-warning">En attente</span>
                                {% elif res.status == 'ANNULEE' %}
                                <span class="badge bg-danger bg-opacity-10 text-danger">Annulée</span>
                                {% else %}
                                <span class="badge bg-secondary text-white">{{ res.status }}</span>
                                {% endif %}
                            </td>
                            <td class="text-end pe-4 fw-bold">{{ res.total_amount|floatformat:0 }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center py-4 text-muted">Aucune réservation récente.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Floating Action Button (FAB) -->
<div class="fab-container">
    <div class="fab-options">
        <div class="fab-item">
            <span class="fab-label">Nouveau Client</span>
            <a href="/admin/core/client/add/" class="fab-btn text-info" style="border: 2px solid #0984e3;">
                <i class="fa-solid fa-user-plus"></i>
            </a>
        </div>
        <div class="fab-item">
            <span class="fab-label">Nouvelle Facture</span>
            <a href="/admin/core/invoice/add/" class="fab-btn text-warning" style="border: 2px solid #fdcb6e;">
                <i class="fa-solid fa-file-invoice-dollar"></i>
            </a>
        </div>
        <div class="fab-item">
            <span class="fab-label">Réservation Rapide</span>
            <a href="/admin/core/reservation/add/" class="fab-btn text-success" style="border: 2px solid #00b894;">
                <i class="fa-solid fa-calendar-plus"></i>
            </a>
        </div>
    </div>
    <div class="fab-main">
        <i class="fa-solid fa-plus"></i>
    </div>
</div>

<!-- Chart Config Script -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- Live Clock ---
        function updateClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');

            const timeString = `${hours} h ${minutes} min ${seconds} s`;
            const timeEl = document.getElementById('live-time');
            if (timeEl) timeEl.textContent = timeString;
        }
        setInterval(updateClock, 1000);
        updateClock();

        // --- Revenue Line Chart ---
        const ctxRev = document.getElementById('revenueChart').getContext('2d');
        const gradient = ctxRev.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(26, 42, 108, 0.2)');
        gradient.addColorStop(1, 'rgba(26, 42, 108, 0)');

        new Chart(ctxRev, {
            type: 'line',
            data: {
                labels: {{ rev_labels| safe }}, // ['Jan', 'Feb', ...]
        datasets: [{
            label: 'Revenus (FCFA)',
            data: {{ rev_data| safe }},
        backgroundColor: gradient,
        borderColor: '#1a2a6c',
        borderWidth: 3,
        pointBackgroundColor: '#fff',
        pointBorderColor: '#1a2a6c',
        pointRadius: 6,
        pointHoverRadius: 8,
        fill: true,
        tension: 0.4
                }]
            },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false }
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: { borderDash: [5, 5] }
            },
            x: {
                grid: { display: false }
            }
        }
    }
        });

    // --- Category Doughnut Chart ---
    const ctxCat = document.getElementById('categoryChart').getContext('2d');
    new Chart(ctxCat, {
        type: 'doughnut',
        data: {
            labels: {{ cat_labels| safe }},
        datasets: [{
            data: {{ cat_data| safe }},
        backgroundColor: [
            '#1B9CFC', // Simple (Blue)
            '#1a2a6c', // Double (Dark Blue)
            '#fdbb2d', // Suite (Gold)
            '#55E6C1'  // Other
        ],
        borderWidth: 0,
        hoverOffset: 10
                }]
            },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '70%',
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    usePointStyle: true,
                    padding: 20
                }
            }
        }
    }
        });
    });
</script>
{% endblock %}